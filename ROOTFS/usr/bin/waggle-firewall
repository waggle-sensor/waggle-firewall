#!/bin/bash -e

# Print the script usage help
print_help() {
  echo """
usage: $0 [-r]

Adds or removes firewall rules.

  -r : deletes firewall rules instead of adding them
  -? : print this help menu
"""
}

DEL=
# Process script input arguments
while getopts "r?" opt; do
  case $opt in
    r) DEL=1
      ;;
    ?|*)
      print_help
      exit 1
      ;;
  esac
done

CONFIGS=("wlan-interface" "wifi-interface" "modem-interface")
RULES=(
	"INPUT -i {{INTF}} -m conntrack ! --ctstate RELATED,ESTABLISHED -j DROP"
	"FORWARD -i {{INTF}} -m conntrack ! --ctstate RELATED,ESTABLISHED -j DROP"
)

INTF=()
for config in "${CONFIGS[@]}"; do
	if waggle-get-config -s hardware -k $config &>/dev/null; then
		INTF+=("$(waggle-get-config -s hardware -k $config)")
	else
		echo "Warning: skipping [$config], not found in config"
	fi
done

for r in "${RULES[@]}"; do
	for i in "${INTF[@]}"; do
		rule=$(echo $r | sed "s/{{INTF}}/$i/g")
		# test if the rule is already applied
		if ! iptables -C $rule &>/dev/null; then
			if [ -z "$DEL" ]; then
				# add mode, rule does not exist
				echo "Add firewall rule [$rule]"
				iptables -I $rule
			else
				# remove mode, rule does not exist
				echo "Warning: not removing rule [$rule], rule does not exist"
			fi
		else
			if [ -z "$DEL" ]; then
				# add mode, rule does exist
				echo "Warning: not applying rule [$rule], already applied"
			else
				# remove mode, rule does exist
				echo "Remove firewall rule [$rule]"
				iptables -D $rule
			fi
		fi
	done
done
